%!TEX encoding = UTF-8 Unicode

%!TEX root = ../compendium2.tex


\Lab{\LabWeekFOUR}
\begin{Goals}
\input{modules/w04-lab-goals.tex}
\end{Goals}

\begin{Preparations}
\item \DoExercise{\ExeWeekFOUR}{04} och repetera {\ExeWeekTWO}, speciellt \code{for yield}. \emph{Det är livsnödvändig kunskap för en pirat!}
\item Läs om integrerade utvecklingsmiljöer i appendix \ref{appendix:ide}.
\item Välj vilken IDE du vill använda på denna lab. Om du inte vet vilken, välj \textbf{Eclipse} med ScalaIDE, som flest handledare känner väl till.
\item Bekanta dig med utvecklingsmiljön genom att skapa ett nytt projekt och gör ett ''Hello World''-program.
\item Ladda hem kursens \emph{workspace} enligt instruktioner i appendix \ref{subsubsection:download--import-workspace} och kontrollera så att du med \emph{Run} kan köra igång de båda ofärdiga \code{main}-metoderna i projektet \code{w04_pirates} inifrån din IDE. Om du inte får rätt på \emph{Run Configuration...} etc. så fråga någon om hjälp.
\item Läs igenom hela laborationen.
%\item {\"O}ppna Scala IDE i Eclipse enligt intruktionerna XX.
%\item Skapa ett projekt och skapa ett \code{object Hello} med en \code{main}-metod enligt XY.
%\item Skriv ut en h{\"a}lsning till terminalen med \code{println("...")} och testk{\"o}r programmet genom att markera filnamnet i projektmenyn och trycka p{\aa} den gr{\"o}na pilen. Kontrollera att h{\"a}lsningen skrivs ut!
\end{Preparations}


\subsection{Bakgrund}


Efter en rad olyckliga omständigheter har du blivit en tidsresande pirat och hamnat i 1700-talets Karibien. Du ska försöka överleva med hjälp av dina hemliga programmeringskunskaper från 2000-talet. För att klara det behöver du datastrukturerna \code{Vector} och \code{Map}, samt använda en integrerad utvecklingsmiljö.
Ditt uppdrag är tvådelat:
\begin{enumerate}
\item Du ska skriva till, och sedan läsa från, en hemlig (nåja) textfil för att spara undan namnen på dina skeppskamrater så att de kan benådas. Du ska även undersöka vad som händer med ditt program om någon illvillig typ får tag i din textfil och försöker inplantera korrupta tecken.
\item Du ska förutsäga vilka ord som kommer ur piraters mun med hjälp av smart ordstatistik och så kallade \emph{bigram}\footnote{\href{https://en.wikipedia.org/wiki/Bigram}{en.wikipedia.org/wiki/Bigram}}. Du ska med hjälp av bigram räkna ut det vanligaste ordet som följer på ett annat.
\end{enumerate}

Till första delen har du det färdiga objektet \code{FileUtils} till din hjälp, som visas i sin helhet nedan. Begrunda dessa hjälpfunktioner, ovärderliga för en pirat i nöd, och försök lista ut hur de fungerar, gärna genom experiment i REPL.
\scalainputlisting[numbers=left,basicstyle=\ttfamily\fontsize{10}{12}\selectfont]{../workspace/w04_pirates/src/main/scala/pirates/FileUtils.scala}

%\noindent Till den andra delen behöver du skapa en ordfrekvensräknare enligt denna specifikation:

%\ScalaSpecInputListing{WordCounter}{../workspace/w04_pirates/src/main/scala/pirates/WordCounter.scala}

%\begin{ScalaSpec}{WordCounter}
%  /** Sparar olika ord och räknar antalet förekomster. */
%  class WordCounter {
%
%    /** Lägger till ordet word och räknar upp dess frekvens. */
%    def addWord(word: String): Unit = ???
%
%    /** Ger det vanligaste ordet och dess frekvens. */
%    def mostCommonWord: (String, Int) =  ???
%
%  }
%\end{ScalaSpec}
%\noindent Fundera på hur ovan specifikation kan implementeras. Du får i nedan labbinstruktioner tips om hur du kan implementera \code{SaveMyCrew} med hjälp av datastrukturen \code{scala.collection.mutable.Map[String, Int]}.

%I resterande delen av kursen kommer vi använda utvecklingsmiljön Eclipse med ScalaIDE. Programmet är installerat på studentdatorerna och det är valfritt att installera det på privata datorer, se instruktionerna i \ref{appendix:ide:eclipse:install}.

%Följ instruktionerna i \ref{appendix:ide:eclipse:use} och gör följande: starta Eclipse med ScalaIDE, bekanta dig med utvecklingsmiljön genom att skapa och exekvera ett program som skriver ut en pirathälsning samt ladda hem kursens \emph{workspace} som innehåller kodskelett för laborationerna och importera koden för laborationen \emph{pirates} till Eclipse.

%\Task Ladda hem zip-filen med kursens workspace från git-repot (XX) och packa upp det på valfritt ställe på din dator. Starta programmet Eclipse och följ instruktionerna i figurer för att skapa ett program och exekvera det.

%Prova att stava fel till \code{println}, då dyker det upp ett rött kryss till vänster på samma kodrad som berättar vad du gjort för fel. Kompilatorn kör i bakgrunden och innan koden kan exekveras måste alla kompileringsfel åtgärdas. Men betyder detta att programmet alltid kommer bete sig korrekt under körningen?


\subsection{Obligatoriska uppgifter}
%Efter en rad olyckliga omständigheter har du blivit pirat i 1700-talets Karibien. Nu beh{\"o}ver du undvika galgen och f{\"o}rs{\"o}ka f{\"o}rutse dina f{\"o}r{\"a}diska skeppskamraters n{\"a}sta steg, naturligtvis utan att \emph{din} lojalitet ifrågasätts.

\subsubsection{Del A: Rädda din besättning}

I denna del ska du först skapa en textfil med namnet på skeppskamraterna. Sedan ska du läsa in filen och skapa en vektor med dina kamrater representerade som objekt med hjälp av en case-klass. Du ska också undersöka vad som händer om filen visar sig vara manipulerad.

\Task \emph{Save your crew}. I följande deluppgifter ska vi steg-för-steg fylla i kodskelettet i filen SaveMyCrew.scala:


\ScalaSpecInputListing{SaveMyCrew}{../workspace/w04_pirates/src/main/scala/pirates/SaveMyCrew.scala}
%\begin{CodeSmall}
%package pirates
%
%object SaveMyCrew {
%  	def main(argh: Array[String]): Unit = {
%  	  	// change this code to your tests!
%
%		val filename = if(!argh.isEmpty) argh(0) else "crew.txt"
%	}
%
%  	def saveCSaveMyCrewrew(fileName:String): Unit = ???
%	// add code for asking the user for crew members and save them to file
%
%	 def readCrew(fileName: String): Unit = ???
%	 // add code for reading the crew from the file
%}
%// Help functions.
%object Utils{
%// Usage: Utils.write("Blah blah blah", "blahFile.txt")
%  def write(s: String, fileName: String): Unit = {
%			import java.nio.file.{Paths, Files, StandardOpenOption}
%			Files.write(Paths.get(fileName), s.getBytes("UTF-8"))
%  }
%
%// Usage: val v = Utils.readLines("minFil.txt")
%  def readLines(fileName: String): Vector[String] = {
%			scala.io.Source.fromFile(fileName)("UTF-8").getLines.toVector
%	}
%
%
%// Usage: val w = Utils.readWords("minFil.txt")
%	def readWords(fileName: String): Vector[String] = {
%			scala.io.Source.fromFile(fileName)("UTF-8").getLines.
%			map(_.replaceAll("[^a-zA-ZåäöÅÄÖ\\s]", " ")).map(_.toLowerCase()).
%			flatMap(_.split("\\s+")).filter(!_.isEmpty).toVector
%	}
%}
%
%// Add your case class here!
%
%\end{CodeSmall}
%

\Subtask Kung George {\"a}r villig att ben{\aa}da {\bf fem} personer ur din bes{\"a}ttning!

Vi ska skapa en lista (nåja, vektor) d{\"a}r personerna sparas med f{\"o}rnamn, efternamn och befattning genom att l{\"a}sa in dem fr{\aa}n konsolen.

Börja med att implementera en \code{case class CrewMember} med förnamn, eftersnamn och befattningen.

\Subtask Inl{\"a}sning från konsolen g{\"o}rs med \code{scala.io} med kodraden:
\begin{Code}
val first = scala.io.StdIn.readLine("Förnamn: ").
\end{Code}

Skriv funktionen \code{saveCrew} som läser in namn och befattning på dina fem besättningsmedlemmar och sparar dem i en {\bf vektor}. \emph{Hint}: du kan spara undan värdet från en for loop till en vektor direkt med hjälp av \code {yield} så här
\begin{CodeSmall}
val crew = for(...) yield {
... // lines to read input from user
	CrewMember(...) // this will be an element in the vector!
}
\end{CodeSmall}


\Subtask Vi vill skriva namnen till en fil så att den faktiskt sparas. Till din hjälp får hjälpobjektet \code{FileUtils} med funktionen \code{save} som tar en sträng \code{s} och sparar den till en fil \code{fileName}. Lägg till kodrader i \code{saveCrew} så att vektorn skrivs till en sträng och sparas till filen \emph{crew.txt}. \emph{Hint}: samlingsklasser har metoden \code{mkString("\n")} som skapar en sträng av innehållet där varje element separeras med en radbrytning. Använd F5 för att uppdatera projektet så att filen dyker upp i Eclipse.



\Subtask Det går att överskugga \code{toString()} i \code{CrewMember} och på så sätt ändra utskriften genom att lägga till följande kodrad inne i klassen:
\begin{Code}
override def toString(): String = ??? // add your code here.
\end{Code}

\noindent Ändra utskriften så att den blir {\em snygg}, t ex med komma\\

\noindent Jack Sparrow, kapten \\
Anne Bonny, mordlysten matros \\
Ed Kenway, lönnmördare \\
...

%\newpage
\Task{Avlusa din besättning.}

\Subtask Din moraliska kompass hindrar dig inte från att också jobba för kung George. Hjälp honom att läsa listan!

En fil \code{fileName} kan läsas rad för rad till en vektor med strängar (en för varje rad) med följande kod som också finns i objektet \code{FileUtils}:

\begin{CodeSmall}
  def readLines(fileName: String): Vector[String] =
    scala.io.Source.fromFile(fileName)("UTF-8").getLines.toVector
\end{CodeSmall}


Fyll i koden i \code{readCrew} som läser in besättningen från filen och skapar en \code{CrewMember} för varje rad. Skriv ut personen till konsolen för att se om det blev korrekt. \emph{Hint}: strängar har många metoder, t ex kan man ersätta alla komman med mellanslag med funktionen \code {replaceAllLiterally(",", "")}, separera med hjälp av \code{split(' ')} och \code{drop(2)} som ger en ny vektor utan de två första elementen.

\Subtask Ändra också i \code{main} och testa ditt program. Stämmer det med filinnehållet? Använd debuggern  för att hitta eventuella fel.

\Subtask Den konkurrerande kaptenen Charles Vane\footnote{hängd för sjöröveri i Port Royal 1721.} betalar dig för att sabotera listan genom att lägga till nonsensrader i filen. Gör det. Vad händer då när du exekverar ditt testprogram?

\Subtask Lägg till några lämpliga if-satser i \code{readCrew} så att en korrekt formaterad rad skapar en \code{CrewMember} medan felaktiga rader skriver ut felmeddelande.
Testa ditt nya program och se om det blir som förväntat genom lämpliga brytpunkter och utskrifter. Går det att lura ditt program (det är OK)?

\subsubsection {Del B: Hur pratar pirater?}

\emph{Lögner, förbannade lögner och statistik}. För att du inte ska bli överlistad av dina sluga, lögnaktiga skeppskamrater behöver du kunna gissa hur en pirat tänker. Därför förkovrar du dig i Robert Louis Stevensons \emph{Skattkammarön}\footnote{Vars copyright har gått ut så du behöver inte piratkopiera den.} som finns i filen \emph{skattkammaron.txt} i workspacet.  Genom att för varje ord spara det mest frekventa nästkommande ordet går det att förutse vad som kommer sägas\footnote{Detta används till exempel i Swiftkey på smarttelefoner.}.


I vårt program ska varje ord få en egen \code{WordCounter} som i sin tur innehåller en samling, i vårt fall en föränderlig \code{Map} med ord och antal som nyckel-värde-par. Ditt uppdrag är att steg-för-steg implementera \code{WordCounter}, räkna bigram i \emph{Skattkammarön} och skriva ett program för att gissa pirat-prat genom att implementera funktionerna i objektet \code{PirateSpeech}.

Kodskelettet vi ska fylla ut steg-för-steg i uppgifterna nedan finns i klassen \code{WordCounter} och i objektet \code{PirateSpeech} och ser ut som följer:
\newpage
\ScalaSpecInputListing{WordCounter}{../workspace/w04_pirates/src/main/scala/pirates/WordCounter.scala}
\ScalaSpecInputListing{PirateSpeech}{../workspace/w04_pirates/src/main/scala/pirates/PirateSpeech.scala}



\code{WordCounter} ska fungera såhär: I texten förekommer ordkombinationerna \emph{och de}, \emph{och jag}, \emph{och återvänder} och lite senare \emph{och jag} igen. Vi skapar en \code{WordCounter} för \emph{och} och lägger till \emph{de}, \emph{jag}, \emph{återvänder} och \emph{jag} och sen ska den bästa gissningen för \emph{och} vara \emph{jag} med antalet 2. \code{WordCounter} behöver alltså en \emph{föränderlig} tabell i form av en \code{scala.collection.mutable.Map[String, Int]} för att räkna förekomsterna av varje ord.


\Subtask Lägg till ett \code{Map}-attribut i \code{WordCounter} för att spara ord (strängar) och antal. Tänk på att välja ett lämpligt namn på attributet. \emph{Hint}: Typerna i en \code{Map} anges inom hakparenteser \code{Map[String, Int]()}.

\Subtask När vårt \code{Map}-attribut skapas är den tom. Implementera funktionen \code{addWord} i \code{WordCounter} som räknar upp antalet förekomster av ett visst ord. Om det är första gången ordet förekommer behöver det läggas in i samlingen med antalet~1. \emph{Hint}: Samlingar har funktionen \code{contains} för att se om ett element finns i den och värden både uppdateras och returneras genom att använda nyckeln inom parentes.

\Subtask Implementera funktionen \code{mostCommonWord} som returnerar en tuppel med bästa gissning och hur ofta den förekommer. Detta kan vi göra på olika sätt, t~ex genom att gå igenom alla tuppler i vår \code{Map} och spara undan den med högst \emph{värde} (se uppgift 12 i övning 2), men en lat pirat använder den färdiga samlingsfunktionen \code{maxBy} för att jämföra tupplernas värden. I en \code{Map} \emph{wordCounter} används det såhär: \code{wordCounter.maxBy(pair => pair._2)} som för varje nyckel-värde-par \emph{pair} bara jämför \emph{värdet} som hämtas med \code{_2}. Det går att skriva samma sak superkort \code{wordCounter.maxBy(_._2)}.

\Subtask Implementera \code{toString} som returnerar ett par med den bästa gissningen och hur ofta den förekom.

\Subtask Testa din klass genom att lägga till kodrader i \code{main} för att skapa en \code{WordCounter} för ett ord, lägg till data med \code{addWord} och avsluta med att skriva ut resultatet. Använd t ex  \emph{och}-exemplet ovan.

\Subtask Nu är det dags att implementera funktionen \code{readBook}. Konceptuellt vill vi göra följande: 1) läsa in all data från textfilen med boken till en vektor med ord, 2) få ut en samling unika ord så att vi kan 3) skapa en \code{WordCounter} för varje ord och slutligen, 4) gå igenom hela boken och räkna ordpar (bigrammen).
\noindent
Du får följande ledtrådar:

\begin{enumerate}
\item \code{FileUtils.readWords} är en funktion för att läsa in ord från en fil med hjälp av \code{scala.io.Source.fromFile}. Funktionen tar bort allt som {\em inte} är svenska bokstäver och separerar orden med hjälp av \code{split} på mellanslag samt gör om alla tecken till gemener.

\item Samlingsklassen \code{Set} tillåter bara unika element, så om man skapar ett tomt Set (\code{... = Set()}) och sen lägger till sina ord med \code{++}  filtreras dubbletter bort.

\item Spara räknaren för varje ord i en \code{Map[String, WordCounter]} där ordsträngen och räknaren är sparade som nyckel-värde-par. Använd funktionen \code{map} på setet för att för varje ord \code{word} skapa ett par (en 2-tuppel) med en ny räknare (\code{word -> new WordCounter}). Resultatet från funktionen \code{map} ger en ny samling av samma typ som ursprungssamlingen, den kan omvandlas till en \code{Map} genom att anropa \code{toMap}!

\item I Övn \ref{exe:W02} lärde vi oss att iterera genom en vektor med \code{for(word <- words)} men nu vill vi få två ord i taget! Vektor-funktionen \code{sliding(2)} ger en minivektor av storlek 2 som vi kan använda för att iterera över ordpar:
\begin{Code}
for(pair <- words.sliding(2)) { ... }
\end{Code}

\item När vi har ett ordpar med två ord, \code{first} och \code{second}, behöver vi plocka fram räknaren för \code{first} från vår \code{counterMap} som i sin tur sköter uppräkningen av ordet \code{second} i \code{addWord}.

\end{enumerate}

\Subtask Testa att ditt program genom att lägga till kodrader i  \code{main} som skriver ut några gissningar, t ex vad kommer troligtvis efter ''och'' respektive ''jim''?
\newline
\newline
\noindent
\emph{Du blir så bra på tankeläsning att dina skeppskamrater anklagar dig för svart magi och din sjörövarhistoria slutar en stormig natt med att du sveps över bord under mystiska omständigheter.}


\subsection{Frivilliga extrauppgifter}
Det är onödigt att läsa in hela boken och räkna alla frekvenser \emph{varje} gång programmet körs. Eftersom boken inte ändras kan du spara resultatet från uträkningen till en fil och bara läsa in \emph{resultatfilen}, dvs, efter att du skrivit \code{readBook} kan du spara varje ord tillsammans med den bästa gissningen till en fil. Sen kan du testa programmet genom att läsa in dessa par ...

\Subtask Fyll i funktionen
\begin{CodeSmall}
def readBook(bookFile: String, saveToFile: String)}
\end{CodeSmall}
så att den, utöver det som din gamla funktion gör, också skapar en sträng där varje rad innehåller ett ord samt dess bästa gissning och sen sparar strängen till filen \code{saveToFile}. Kontrollera att utskriften till filen ser OK ut.

\Subtask Skriv funktionen \code{testSpeech(savedFile: String)} så att den läser in raderna från din sparade fil med \code{Utils.readLines}. Ordet och gissningen ska sparas i en \code{Map[String, String]}.  Testa slutligen ditt program med några väl valda ord.

\emph{Hint}: dela upp strängen på ord med hjälp av \code{split(...)}. Kom ihåg att det går att generera samlingar direkt med hjälp av en forloop \begin{CodeSmall}
val s = for(...) yield{
...
// element
}

\end{CodeSmall}
Vilken samlingstyp blir resultatet? I labben lärde du dig två sätt att konvertera mellan olika typer av samlingar, antingen kan du skapa en tom samling  och lägga in elementen med \code{++} eller anropa konverteringsfunktioner som \code{toMap}.


%\Subtask En underuppgift.

%\Subtask En underuppgift.
